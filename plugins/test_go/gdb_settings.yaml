---

commands:
    info_source:
        steps:
            - run_command:
                command: 'list'
            - run_command_with_match:
                command: 'info source'
                match: 'Located in (.*)\"$'
                match_group: 1
                try_set: 'current_filename'
            - set_buffer:
                buffer_name: 'vg_code'
                file_name: "{{ current_filename }}"
            - run_command_with_match:
                command: 'backtrace'
                match: '^~\"#0\s+.*at(.*):(\d+)\"$'
                match_group: 2
                try_set: 'current_line_number'
    set_highlight_line:
        steps:
            - run_vim_function:
                function_name: 'buffer_breakpoint#set_highlight_line'
                event_input_args:
                    highlight_line_variable: 'current_line_number'
    set_breakpoint:
        steps:
            - get_current_buffer_line:
                set_variable: 'current_buffer_line'
            - get_current_buffer_name:
                set_variable: 'current_buffer_name'
            - set_var:
                name: 'breakpoint_command'
                value: 'break {{ current_buffer_name }}:{{ current_buffer_line }}'
            - run_command_string:
                variable_name: 'breakpoint_command'
            - run_config_command:
                name: 'set_piets'
                input_args:
                    piet_match_array_variable: 'file_lines'
                    current_filename_variable: 'current_buffer_name'
    continue:
        steps:
            - run_command:
                command: 'continue'
            - run_config_command:
                name: 'info_source'
    run:
        steps:
            - run_command:
                command: 'run'
            - run_config_command:
                name: 'info_source'
    step:
        steps:
            - run_command:
                command: 'step'
            - run_config_command:
                name: 'info_source'
    set_highlight_for_breakpoint_and_diff:
        steps:
            - run_vim_function:
                function_name: 'set_highlight#for_breakpoint_and_diff'
    set_piets:
        steps:
            - run_command_with_match:
                command: 'info breakpoints'
                match: '^~\"\d+\s+.*at\s(.*)\"$'
                match_group: 1
                try_set_array: 'file_lines'
            - run_vim_function:
                function_name: 'buffer_piets#set_piets'
    list_locals:
        steps:
            - run_command:
                command: 'info locals'
    display_template:
        steps:
            - display_template:
                filename: 'test_template.j2'

variables:
    current_filename: ''
    current_line_number: 0
    file_lines: []
    current_buffer_name: ''
    current_buffer_line: 0
    breakpoint_highlight_color: 'darkred'

events:
    after_startup:
        - 'set_highlight_for_breakpoint_and_diff'
        - 'info_source'

buffers:
    vg_session_log:
        on_startup: true
    vg_locals:
        on_startup: false
        command: 'list_locals'
    vg_test_template:
        on_startup: true
        command: 'display_template'
    vg_code:
        on_startup: true
        line_numbers: true
        buffer_filename_variable: 'current_filename'
        primary_window: true
        language: 'c'
        events:
            after_command:
                - command: 'set_piets'
                  input_args:
                      piet_match_array_variable: 'file_lines'
                      current_filename_variable: 'current_filename'
                - command: 'set_highlight_line'

settings:
    process:
        ttl_stream_timeout: 0.08
        main_process_name: 'gdb'
        main_process_default_arguments: ' -q --interpreter=mi2 '
        end_of_output_regex: '\(gdb\)'
    plugins:
        filters_path: './filters'
        functions_path: './functions'
        templates_path: './templates'
